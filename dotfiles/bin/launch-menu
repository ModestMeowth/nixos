#!/usr/bin/env bash
set -x

BACK_TO_EXIT=false

back_to() {
    local parent_menu
    parent_menu="$1"

    if [[ "$BACK_TO_EXIT" == "true" ]]; then
        exit 0
    elif [[ -n "$parent_menu" ]]; then
        "$parent_menu"
    else
        show_main_menu
    fi
}

menu() {
    local prompt options extra preselect index

    prompt="$1"
    options="$2"
    extra="$3"
    preselect="$4"

    read -r -a args <<<"$extra"

    if [[ -n "$preselect" ]]; then
        index=$(echo -e "$options" | grep -nxF "$preselect" | cut -d: -f1)
        if [[ -n "$index" ]]; then
              args+=("-c" "$index")
        fi
    fi

    echo -e "$options" | launch-walker --dmenu --width 295 --minheight 1 --maxheight 630 -p "$prompt…" "${args[@]}" 2>/dev/null
}

get_webcam_list() {
    v4l2-ctl --list-devices 2>/dev/null | while IFS= read -r line; do
        if [[ "$line" != $'\t' && -n "$line" ]]; then
            local name
            name="$line"
            IFS= read -r device || break
            device=$(echo "$device" | tr -d '\t' | head -1)
            [[ -n "$device" ]] && echo "$device  $name"
        fi
    done
}

show_webcam_select_menu() {
    local devices count
    devices=$(get_webcam_list)
    count=$(echo "$devices" | grep -c . 2>/dev/null || echo 0)

    if [[ -z "$devices" || "$count" -eq 0 ]]; then
        notify-send "No webcam devices found" -u critical -t 3000
        return 1
    fi

    if [[ "$count" -eq 1 ]]; then
        echo "$devices" | awk '{print $1}'
    else
        menu "Select Webcam" "$devices" | awk '{print $1}'
    fi
}

show_capture_menu() {
    case $(menu "Capture" "  Screenshot\n  Screenrecord\n󰃉  Color") in
    *Screenshot*) screenshot ;;
    *Screenrecord*) show_screenrecord_menu ;;
    *Color*) pkill hyprpicker || hyprpicker -a ;;
    *) show_main_menu ;;
    esac
}

show_screenrecord_menu() {
    screenrecord --stop-recording && exit 0

    case $(menu "Screenrecord" "  With desktop audio\n  With desktop + microphone audio\n  With desktop + microphone audio + webcam") in
    *"With desktop audio") screenrecord --with-desktop-audio ;;
    *"With desktop + microphone audio") screenrecord --with-desktop-audio --with-microphone-audio ;;
    *"With desktop + microphone audio + webcam")
        local device
        device=$(show_webcam_select_menu) || {
            back_to show_capture_menu
            return
        }
        screenrecord --with-desktop-audio --with-microphone-audio --with-webcam --webcam-device="$device"
        ;;
    *) back_to show_capture_menu ;;
    esac
}

show_system_menu() {
    local options
    options="  Lock\n󱄄  Screensaver\n󰍃 Logout\n󰒲  Suspend\n󰜉  Restart\n󰐥  Shutdown"

    case $(menu "System" "$options") in
    *Lock*) lock-screen ;;
    *Screensaver*) launch-screensaver ;;
    *Suspend*) systemctl suspend ;;
    *Logout*) cmd-logout ;;
    *Restart*) cmd-reboot ;;
    *Shutdown*) cmd-poweroff ;;
    esac
}

show_main_menu() {
    go_to_menu "$(menu "Go" "󰀻  Apps\n  Capture\n  System")"
}

go_to_menu() {
    case "${1,,}" in
    *apps*) walker -p "Launch…" ;;
    *capture*) show_capture_menu ;;
    *screenshot*) show_screenshot_menu ;;
    *screenrecord*) show_screenrecord_menu ;;
    *system*) show_system_menu ;;
    esac
}

if [[ -n "$1" ]]; then
    BACK_TO_EXIT=true
    go_to_menu "$1"
else
    show_main_menu
fi
